<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#34495e">
  <title>《JavaScript 高级程序设计》学习笔记-函数表达式 | 阿有的博客</title>
  <link rel="alternate" href="path/of/rss" type="application/atom+xml">
  <link rel="shortcut icon" type="image/ico" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  

  

  

  

</head>

<body>
  <div class="mobile-header">
    <span><i class="iconfont icon-turnon" id="mobile-nav-toggle"></i></span>
    <div class="mobile-logo">
      <a href="/.">SongXingguo‘s blog</a>
    </div>
  </div>
  <div class="page" id="mobile-nav-panel">
    <div class="container">
      <header class="site-nav">
      <div class="nav-content">
        <div class="logo">
          <a href="/">SongXingguo‘s blog</a>
        </div>
        <nav class="navbar">
          <ul>
            
              <li class="menu-item">
                <a href="/" class="menu-item-link"><i class="iconfont icon-home"></i>首页</a>
              </li>
            
              <li class="menu-item">
                <a href="/archives" class="menu-item-link"><i class="iconfont icon-archive"></i>归档</a>
              </li>
            
              <li class="menu-item">
                <a href="/categories" class="menu-item-link"><i class="iconfont icon-category"></i>分类</a>
              </li>
            
              <li class="menu-item">
                <a href="/tags" class="menu-item-link"><i class="iconfont icon-tags"></i>标签</a>
              </li>
            
              <li class="menu-item">
                <a href="/works" class="menu-item-link"><i class="iconfont icon-works"></i>作品</a>
              </li>
            
              <li class="menu-item">
                <a href="/about" class="menu-item-link"><i class="iconfont icon-about"></i>关于</a>
              </li>
            
          </ul>
        </nav>
      </div>
</header>

      <div class="banner">
  <div class="show">
    <!-- <img src="/" alt="banner"> -->
    <div class="banner-title">
      
        <div class="post-title">
          《JavaScript 高级程序设计》学习笔记-函数表达式
            <div class="post-tags">
    		    
              <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>
            
    	      </div>
        </div>
      
    </div>
  </div>
</div>

      <main class="main"id="main">
          <article class="post">
  

  <header>
    <div class="post-title mobile-post-title">
      <h1>《JavaScript 高级程序设计》学习笔记-函数表达式</h1>
        <div class="post-tags">
        
          <a class="tag-link" href="/tags/JavaScript/">JavaScript</a>
        
        </div>
    </div>
    <div class="post-meta">
      <span class="post-time"><i class="iconfont icon-calendar"></i>2018-08-17</span>
      
          
            <i class="iconfont icon-divide"></i>
            <i class="iconfont icon-folder" style="color: #8a8a8a;"></i>
            <a class="post-category" href="/categories/前端技术/">前端技术</a>
          
            <i class="iconfont icon-divide"></i>
            <i class="iconfont icon-folder" style="color: #8a8a8a;"></i>
            <a class="post-category" href="/categories/前端技术/读书笔记/">读书笔记</a>
          
      
      <!----------------------------------->
        
          <i class="iconfont icon-divide"></i>
          <div class="post-visits"
               data-url="/2018/08/17/vaScript-function-expression/"
               data-title="《JavaScript 高级程序设计》学习笔记-函数表达式">
              阅读次数
            </div>
        
      <!----------------------------------->
    </div>
  </header>
  
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#函数表达式"><span class="toc-text">函数表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#递归"><span class="toc-text">递归</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#闭包"><span class="toc-text">闭包</span></a></li></ol></li></ol>
    </div>
  </div>


  <div class="post-content">
    <h1 id="函数表达式"><a href="#函数表达式" class="headerlink" title="函数表达式"></a>函数表达式</h1><p>函数表达式是 JavaScript 中的一个既强又容易令人困惑的特性。定义函数的方式有两种：一种是 <strong>函数声明</strong> ，另一种就是 <strong>函数表达式</strong> 。<strong>函数声明</strong> 的语法是这样的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">functionName</span>(<span class="params">arg0, arg1, arg2</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 函数体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是 function 关键字，然后是函数的名字，这就是指定函数名的方式。Firefox、Safari、Chrome 和 Opera 都给函数定义了一个非标准的 name 属性，通过这个属性可以访问到给函数指定的名字。这个属性的值永远等于跟在 function 关键字后面的标识符。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只是 Firefox、Safari、Chrome 和 Opera 有效</span></span><br><span class="line">alert(functionName.name); <span class="comment">// "fcuntionName"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>关于函数声明，它的一个重复特征就是 <strong>函数提升</strong>（function declaration hoisting），意思是在 <strong>执行代码之前会读取函数声明</strong> 。<strong>这意味着可以把函数声明放在调用它的语句后面</strong> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sayHi();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">"Hi!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子不会抛出错误，因为代码执行之前会先读取函数声明。<br>第二种创建函数的方式是使用 <strong>函数表达式</strong> 。函数表达式有几种不同的形式。下面是最常见的一个形式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> functionName = <span class="function"><span class="keyword">function</span>(<span class="params">arg0, arg1, arg2</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 函数体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种形式看起来好像是常规的变量赋值语句，即创建一个函数并将它赋值给变量 functionName 。这种情况下创的函数叫做 <strong>匿名函数</strong>（anonymous function）,因为 <strong>function 关键字后面没有标识符</strong> 。（匿名函数有时候也叫拉姆达函数。）匿名函数的 name 属性是空字符串。<br><strong>函数表达式与其他表达式一样</strong> ，<strong>在使用前必须先赋值</strong> 。以下代码会导致错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sayHi();  <span class="comment">//错误；函数还不存在</span></span><br><span class="line"><span class="keyword">var</span> sayHi = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">"Hi!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>理解函数提升的关键，就是 <strong>理解函数声明与函数表达式之间的区别</strong> 。例如，执行以下代码的结果可能会让人意想不到。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不要这样做！</span></span><br><span class="line"><span class="keyword">if</span>(condition)&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"Hi!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"Yo!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>表面上看，以上代码表示 conditionn 为 true 时，使用一个 sayHi() 的定义；否则，就使用另一个定义。实际上，这 <strong>在 ECMAScript 中属于无效语法</strong> ，<strong>JavaScript引擎会尝试修正错误，将其转换为合理的状态</strong> 。但问题是 <strong>浏览器尝试修正错误的做法并不一致</strong> 。大多数浏览器会返回第二个声明，忽略 condition ; Firefox 会在 condition 为 ture 时返回第一个声明。因此这种使用方式很危险，不应该出现在你的代码中。不过，<strong>如果是使用函数表达式，那就没有什么问题了</strong> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以这样做</span></span><br><span class="line"><span class="keyword">var</span> sayHi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (condition) &#123;</span><br><span class="line">  sayHi = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"Hi!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   sayHi = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     alert(<span class="string">"Yo!"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子不会有什么意外，不同函数会根据 condition 被赋值 sayHi。</p>
<p>能够创建函数再赋值给变量，也就能够把函数作为其他函数的值返回。下面是 createComparisonFunction() 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCompariseFunction</span>(<span class="params">propertyName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">object1, object2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> value1 = object1[propertyName];</span><br><span class="line">    <span class="keyword">var</span> value2 = object2[propertyName];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (value1 &lt; value2) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> i f (value1 &gt; value2) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>createComparisonFunction() 就返回了一个匿名函数。返回的函数可能会被赋值给一个变量，或者以其他方式被调用；不过，<strong>在 createComparisonFunction() 函数内部，它是匿名的</strong> 。在把函数当成值来使用的情况下，都可以使用匿名函数。不过，这并不是匿名函数唯一的用途。</p>
<h2 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h2><p>递归函数是在一个函数通过名字调用自身的情况下构成的，如下所示。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (num &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> num * factorial(num <span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个经典的递归阶乘函数。虽然这个函数表面看来没什么问题，但下面的代码却可能导致它出错。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> anotherFactorial = factorial;</span><br><span class="line">factorial = <span class="literal">null</span>;</span><br><span class="line">alert(anotherFactorial(<span class="number">4</span>)); <span class="comment">//出错！</span></span><br></pre></td></tr></table></figure>
<p>以上代码先把 factorial() 函数保存在变量 anotherFactorial 中，然后将 factorial 变量设置为 null, 结果  <strong>指向原始函数的引用只剩下一个</strong> 。但在接下来调用 anotherFactorial() 时，由于  <strong>必须执行 factorial()</strong> ，而 <strong>factorial 已经不再是函数</strong>，所以就会导致错误。在这种情况下，使用 arguments.callee 可以解决这个问题。</p>
<p>我们知道，<strong>arguments.callee 是一个指向正在执行的函数的指针</strong> ，，因此可以用它来实现对函数的递归调用，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (num &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> num  * <span class="built_in">arguments</span>.callee(num <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加粗的代码显示，通过使用 arguments.callee 代替函数名，可以确保无论怎样调用函数都不会出问题。因此，在编写递归函数时，使用 arguments.callee 总比使用函数名更保险。</p>
<p>但在 <strong>严格模式</strong> 下，<strong>不能通过脚本访问 arguments.callee</strong> ，访问这个属性会导致错误。不过，<strong>可以使用命名函数表达式达成相同的结果</strong> 。例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> factorial (<span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (num &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> num * f(num <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>以上代码创建了一个 <strong>名为 f() 的命名函数表达式</strong> ，然后 <strong>将它赋值给变量 factorial</strong> 。即使把函数赋值给了另一个变量，函数的名字 f 仍然有效，所以递归调用照样能正确完成。这种方式在严格模式和非严格模式下都行得通。</p>
<h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p>有不少开发人员总是搞不清 <strong>匿名函数</strong> 和 <strong>闭包</strong> 这两个概念。因此经常混用。<strong>闭包</strong> 是指 <strong>有权访问另一个函数作用域中变量的函数</strong> 。<strong>创建闭包的常见方式</strong> ，就是 <strong>在一个函数内部创建另一个函数</strong> ，仍以前面的 createComparisonFuncton() 函数为例，请注意加粗的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">functioon createComparisonFunction(propertyName) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">object1, object2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> value1 = object1[propertyName];</span><br><span class="line">    <span class="keyword">var</span> value2 = object2[propertyName];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (value1 &lt; value2) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> i f (value1 &gt; value2) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个例子中，突出的那两行代码是 <strong>内部函数（一个匿名函数）中的代码</strong> ，<strong>这两行代码访问了外部函数中的变量 propertyName</strong> 。即使这个内部函数被返回了，而且是在其他地方被调用了 ，但它仍然可以访问变量 propertyName。<strong>之所以还能够访问这个变量</strong> ，是因为 <strong>内部函数的作用域链中包含 createComparisonFunction() 的作用域</strong> 。要彻底搞清楚其中的细节，必须从理解函数被调用的时候都会发生什么入手。</p>
<p>前面作用域链的概念。而 <strong>有关如何创建作用域链以及作用域链有什么作用的细</strong> 节，对彻底理解闭包至关重要。当 <strong>某个函数被调用</strong> 时，<strong>会创建</strong> 一个 <strong>执行环境</strong>（execution contect）及 <strong>相应的作用域链</strong> 。然后，<strong>使用 arguments 和其他命名参数的值来初始化函数的活动对象</strong> （ activation object）。但 <strong>在作用域链中</strong> ，<strong>外部函数的活动对象始终处于第二位</strong>，<strong>外部函数的外部函数的活动对象处于第三位</strong> ，……<strong>直至作为作用域链终点的全局执行环境</strong> 。</p>

  </div>
  <div class="post-footer">the end</div>
</article>

          
  <nav class="pagination post-nav">
    
    
      <a href="/2018/08/14/JavaScript-object-oriented/">
        <span class="next-post">《JavaScript 高级程序设计》学习笔记-面向对象程序设计<i class="iconfont icon-more"></i></span>
      </a>
    
  </nav>


          
  


      </main>
    </div>
    <footer>
      <div class="social-links">
        
          
            <a href="https://github.com/songxingguo"><i class="iconfont icon-github"></i></a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
      
        <div class="quote">
          <p>专注，极致，快</p>
        </div>
      
      <div class="copyright">
        <p>
          由 <a href="https://hexo.io/">Hexo</a> 强力驱动
          <span>|</span>
          主题 - <a href="https://github.com/wa-ri/hexo-theme-ztopic">ztopic</a>
          <span>|</span>
          Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
        </p>
        <p>
          <span>
          
          &copy;
          
            2018
          
          </span>
          <i class="iconfont icon-circle"></i>
          <span>songxingguo</span>
        </p>
      </div>
</footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <div id="mobile-nav">
  <nav id="mobile-nav-menu">
    
      <a href="/" class="mobile-nav-link"><i class="iconfont icon-home"></i>首页</a>
    
      <a href="/archives" class="mobile-nav-link"><i class="iconfont icon-archive"></i>归档</a>
    
      <a href="/categories" class="mobile-nav-link"><i class="iconfont icon-category"></i>分类</a>
    
      <a href="/tags" class="mobile-nav-link"><i class="iconfont icon-tags"></i>标签</a>
    
      <a href="/works" class="mobile-nav-link"><i class="iconfont icon-works"></i>作品</a>
    
      <a href="/about" class="mobile-nav-link"><i class="iconfont icon-about"></i>关于</a>
    
    <div class="mobile-intro"><i class="iconfont icon-pen"></i>写文章，做分享</div>
  </nav>
</div>


  <script src="/libs/jQuery/jquery-3.2.1.min.js"></script>
  <script src="/libs/slideout/slideout.min.js"></script>
  
    <link rel="stylesheet" href="/libs/fancybox/jquery.fancybox.css">
    <script src="/libs/fancybox/jquery.fancybox.pack.js"></script>
  
  
  <script src="//cdn1.lncld.net/static/js/3.2.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
        appId: "MNdCoL1O2i2njgRy8WVYgAwf-gzGzoHsz",
        appKey: "hil0yQTQDbO8nzaxFKqeSqyK"
      });
  </script>
  <script>
  (function (window) {
      $(document).ready(function () {
        visits();
      });
    function visits() {
      var $visits = $('.post-visits');

      function updateVisits(dom, time) {
        var text = dom.text() + ' ' + time;
        dom.text(text);
      }

      function addCounter(Counter) {
        var query = new AV.Query(Counter);

        var url = $visits.data('url').trim();
        var title = $visits.data('title').trim();

        query.equalTo('url', url);
        query.find().then(function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.save(null, {
              fetchWhenSave: true
            }).then(function (counter) {
              counter.increment('time', 1);
              return counter.save();
            }).then(function (counter) {
              updateVisits($visits, counter.get('time'));
            });
          } else {
            var newcounter = new Counter();
            newcounter.set('title', title);
            newcounter.set('url', url);
            newcounter.set('time', 1);

            newcounter.save().then(function (counter) {
              updateVisits($visits, newcounter.get('time'));
            });
          }
        }, function (error) {
          console.log('Error:' + error.code + " " + error.message);
        });
      }

      function showTime(Counter) {
        $visits.each(function () {
          var $this = $(this);
          var query = new AV.Query(Counter);
          var url = $this.data('url').trim();

          query.equalTo('url', url);
          query.find().then(function (results) {
            if (results.length === 0) {
              updateVisits($this, 0);
            } else {
              var counter = results[0];
              updateVisits($this, counter.get('time'));
            }
          }, function (error) {
            console.log('Error:' + error.code + " " + error.message);
          });
        })
      }

      if (typeof AV === 'object') {
        var Counter = AV.Object.extend('Counter');
        if ($visits.length === 1) {
          addCounter(Counter);
        } else {
          showTime(Counter);
        }
      }
    }
  })(window);
  </script>


  <script src="/js/ztopic.js"></script>
</body>
</html>
